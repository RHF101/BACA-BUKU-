<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login / Daftar - Reading Haven</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <nav class="navbar">
        <div class="logo">Reading Haven</div>
        <div class="nav-links">
            <a href="index.html">Kembali ke Home</a>
        </div>
    </nav>

    <main class="auth-page">
        <div class="auth-container">
            <h1>Masuk atau Daftar</h1>

            <!-- Form Login -->
            <form id="login-form" class="auth-form">
                <h2>Login</h2>
                <input type="email" id="email" placeholder="Email" required autocomplete="email">
                <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
                <button type="submit">Masuk</button>
            </form>

            <div style="text-align:center; margin: 1.5rem 0; color:#888; font-size:0.95rem;">
                ─────────────── atau ───────────────
            </div>

            <!-- Form Daftar -->
            <form id="register-form" class="auth-form">
                <h2>Buat Akun Baru</h2>
                <input type="text" id="name" placeholder="Nama Lengkap" required autocomplete="name">
                <input type="email" id="reg-email" placeholder="Email" required autocomplete="email">
                <input type="password" id="reg-password" placeholder="Password (minimal 6 karakter)" required autocomplete="new-password">
                <button type="submit">Daftar</button>
            </form>

            <p id="auth-message" style="text-align:center; min-height:1.8rem; margin-top:1.5rem; font-weight:500;"></p>
        </div>
    </main>

    <!-- ====================================================
         Firebase + Authentication + Realtime Database
         Semua inisialisasi dilakukan langsung di sini
    ==================================================== -->
    <script type="module">
        // Import SDK yang dibutuhkan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

        import {
            getDatabase,
            ref,
            set,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        // Konfigurasi Firebase (project Anda)
        const firebaseConfig = {
            apiKey:            "AIzaSyCs7Vnysf25BwhN2-fPTODd48xwzbPkbzI",
            authDomain:        "rhf-shop-mafia-8d2e5.firebaseapp.com",
            databaseURL:       "https://rhf-shop-mafia-8d2e5-default-rtdb.firebaseio.com",
            projectId:         "rhf-shop-mafia-8d2e5",
            storageBucket:     "rhf-shop-mafia-8d2e5.firebasestorage.app",
            messagingSenderId: "158711184948",
            appId:             "1:158711184948:web:9223f07fa6658601189461",
            measurementId:     "G-R6KN1EYMB3"
        };

        // Inisialisasi Firebase
        const app  = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db   = getDatabase(app);

        const messageEl = document.getElementById('auth-message');

        // =============================================
        //                  LOGIN
        // =============================================
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email    = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            messageEl.style.color = '#e74c3c';
            messageEl.textContent = 'Memproses login...';

            try {
                await signInWithEmailAndPassword(auth, email, password);

                messageEl.style.color = '#27ae60';
                messageEl.textContent = 'Login berhasil! Mengarahkan ke halaman utama...';

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1800);
            } catch (error) {
                let msg = 'Terjadi kesalahan';

                if (error.code === 'auth/wrong-password') {
                    msg = 'Kata sandi salah';
                } else if (error.code === 'auth/user-not-found') {
                    msg = 'Email tidak terdaftar';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'Format email tidak valid';
                } else if (error.code === 'auth/too-many-requests') {
                    msg = 'Terlalu banyak percobaan. Coba lagi nanti';
                } else {
                    msg = error.message;
                }

                messageEl.textContent = msg;
            }
        });

        // =============================================
        //                 DAFTAR (REGISTER)
        // =============================================
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const name     = document.getElementById('name').value.trim();
            const email    = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;

            if (name.length < 2) {
                messageEl.style.color = '#e74c3c';
                messageEl.textContent = 'Nama minimal 2 karakter';
                return;
            }

            messageEl.style.color = '#e74c3c';
            messageEl.textContent = 'Memproses pendaftaran...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Simpan data user ke Realtime Database
                await set(ref(db, 'users/' + user.uid), {
                    name: name,
                    email: email,
                    role: 'user',
                    purchasedBooks: {},
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                messageEl.style.color = '#27ae60';
                messageEl.textContent = 'Akun berhasil dibuat! Silakan login di atas.';

            } catch (error) {
                let msg = 'Terjadi kesalahan';

                if (error.code === 'auth/email-already-in-use') {
                    msg = 'Email sudah terdaftar';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'Kata sandi terlalu lemah (minimal 6 karakter)';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'Format email tidak valid';
                } else {
                    msg = error.message;
                }

                messageEl.textContent = msg;
            }
        });

        // Optional: Jika user sudah login, arahkan ke home
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Jika sudah login tapi masih di halaman login → redirect
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1200);
            }
        });
    </script>

</body>
</html>
