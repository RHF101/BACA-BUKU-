<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel — Reading Haven</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #f9f7f3;
      --card:      #ffffff;
      --text:      #2d2a26;
      --text-light:#6b665f;
      --accent:    #a8b5a2;
      --accent-dk: #8a9a84;
      --danger:    #c0392b;
      --success:   #27ae60;
      --shadow-sm: 0 4px 14px rgba(0,0,0,0.06);
      --shadow:    0 10px 38px rgba(0,0,0,0.08);
      --radius:    14px;
    }

    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }

    .navbar { background: white; border-bottom: 1px solid rgba(168,181,162,0.2); padding: 1.1rem 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }

    .logo { font-family: 'Playfair Display', serif; font-size: 1.6rem; color: var(--accent-dk); font-weight: 600; }

    .nav-links a, .nav-links button { margin-left: 1.8rem; color: var(--text-light); text-decoration: none; font-weight: 500; cursor: pointer; }

    .nav-links button { background: var(--danger); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; }

    main { max-width: 1200px; margin: 2.5rem auto; padding: 0 5%; }

    h1 { font-family: 'Playfair Display', serif; color: var(--accent-dk); margin-bottom: 0.8rem; }

    .status { font-size: 1.05rem; margin-bottom: 2rem; min-height: 1.6rem; }

    .section { background: white; border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow); margin-bottom: 2.5rem; }

    h2 { margin-bottom: 1.4rem; color: var(--accent-dk); }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.3rem; }

    .form-grid > * { grid-column: span 1; }

    .form-grid > [data-full] { grid-column: span 2; }

    label { font-weight: 500; color: #555; margin-bottom: 0.4rem; display: block; }

    input, select, textarea { width: 100%; padding: 0.85rem 1rem; border: 1px solid #e0ded9; border-radius: 10px; font-size: 1rem; }

    button { padding: 0.9rem 1.8rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }

    .btn-primary { background: var(--accent-dk); color: white; }

    .btn-danger { background: var(--danger); color: white; }

    .list-item { padding: 1.1rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }

    .list-item:last-child { border-bottom: none; }

    #book-message, #status { text-align: center; margin: 1rem 0; font-weight: 500; min-height: 1.5rem; }

    .note { font-size: 0.85rem; color: #777; margin-top: 0.4rem; }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="logo">Reading Haven Admin</div>
  <div class="nav-links">
    <a href="index.html">Beranda</a>
    <button id="logout">Keluar</button>
  </div>
</nav>

<main>
  <h1>Panel Admin</h1>
  <div class="status" id="status">Memeriksa hak akses...</div>

  <div class="section">
    <h2>Tambah Buku Baru</h2>
    <form id="book-form" class="form-grid">
      <div>
        <label>Judul Buku</label>
        <input type="text" id="title" required>
      </div>
      <div>
        <label>Penulis</label>
        <input type="text" id="author" required>
      </div>
      <div>
        <label>Kategori</label>
        <select id="category" required>
          <option value="">Pilih...</option>
          <option value="gratis">Gratis</option>
          <option value="premium">Premium</option>
        </select>
      </div>
      <div id="price-row" style="display:none;">
        <label>Harga (Rp)</label>
        <input type="number" id="price" min="1000" step="1000">
      </div>
      <div>
        <label>Status</label>
        <select id="status" required>
          <option value="" disabled selected>Pilih status</option>
          <option value="draft">Draft</option>
          <option value="published">Published</option>
        </select>
      </div>
      <div>
        <label>URL Cover Buku (HTTPS)</label>
        <input type="url" id="cover-url" placeholder="https://i.imgur.com/xxxxxx.jpg" required>
        <div class="note">Paste link dari Imgur, Postimages, atau GitHub Raw</div>
      </div>
      <div data-full>
        <label>Isi Buku (.html dari komputer)</label>
        <input type="file" id="book-content-file" accept=".html,.htm" required>
        <div class="note">File .html akan dibaca dan disimpan sebagai teks aman di database</div>
      </div>
      <div data-full>
        <label>Deskripsi Singkat</label>
        <textarea id="description" rows="4" placeholder="Ringkasan buku untuk halaman detail" required></textarea>
      </div>
      <div data-full style="text-align:right; margin-top:1.5rem;">
        <p id="book-message"></p>
        <button type="submit" class="btn-primary">Simpan Buku</button>
      </div>
    </form>
  </div>

  <div class="section">
    <h2>Daftar Buku</h2>
    <div id="book-list"></div>
  </div>

  <div class="section">
    <h2>Daftar Pengguna</h2>
    <div id="user-list"></div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getDatabase, ref, get, set, remove, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCs7Vnysf25BwhN2-fPTODd48xwzbPkbzI",
    authDomain: "rhf-shop-mafia-8d2e5.firebaseapp.com",
    databaseURL: "https://rhf-shop-mafia-8d2e5-default-rtdb.firebaseio.com",
    projectId: "rhf-shop-mafia-8d2e5",
    storageBucket: "rhf-shop-mafia-8d2e5.firebasestorage.app",
    messagingSenderId: "158711184948",
    appId: "1:158711184948:web:9223f07fa6658601189461",
    measurementId: "G-R6KN1EYMB3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  const statusEl = document.getElementById('status');
  const bookMessage = document.getElementById('book-message');
  const bookList = document.getElementById('book-list');
  const userList = document.getElementById('user-list');

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      statusEl.textContent = 'Silakan login terlebih dahulu';
      setTimeout(() => location.href = 'login.html', 1800);
      return;
    }

    const userSnap = await get(ref(db, `users/${user.uid}`));
    const userData = userSnap.val();

    if (!userData || userData.role !== 'admin') {
      statusEl.textContent = 'Akses ditolak: Anda bukan admin';
      setTimeout(() => location.href = 'index.html', 2200);
      return;
    }

    statusEl.innerHTML = `Selamat datang, <strong>${userData.name || 'Admin'}</strong>`;
    statusEl.style.color = 'var(--accent-dk)';

    document.getElementById('logout').onclick = () => signOut(auth).then(() => location.href = 'login.html');

    loadDashboard();
    loadBooks();
    loadUsers();
  });

  async function loadDashboard() {
    const usersSnap = await get(ref(db, 'users'));
    const booksSnap = await get(ref(db, 'books'));

    const u = usersSnap.val() || {};
    const b = booksSnap.val() || {};

    document.getElementById('total-users').textContent = Object.keys(u).length;
    document.getElementById('total-books').textContent = Object.keys(b).length;

    let g = 0, p = 0;
    Object.values(b).forEach(book => {
      if (book.category === 'gratis') g++;
      if (book.category === 'premium') p++;
    });

    document.getElementById('gratis').textContent = g;
    document.getElementById('premium').textContent = p;
  }

  document.getElementById('book-form').addEventListener('submit', async e => {
    e.preventDefault();

    bookMessage.textContent = 'Memproses...';
    bookMessage.style.color = '#555';

    const title       = document.getElementById('title').value.trim();
    const author      = document.getElementById('author').value.trim();
    const category    = document.getElementById('category').value;
    const price       = category === 'premium' ? Number(document.getElementById('price').value) || 0 : 0;
    const status      = document.getElementById('status').value;
    const coverURL    = document.getElementById('cover-url').value.trim();
    const contentFile = document.getElementById('book-content-file').files[0];
    const description = document.getElementById('description').value.trim();

    // Pengecekan ketat
    if (!title) return showError('Judul buku wajib diisi');
    if (!author) return showError('Penulis wajib diisi');
    if (!category) return showError('Pilih kategori buku');
    if (!status) return showError('Pilih status buku (Draft atau Published)');
    if (!coverURL || !coverURL.startsWith('https://')) return showError('URL cover harus HTTPS dan valid');
    if (!contentFile) return showError('Pilih file isi buku (.html)');
    if (!description) return showError('Deskripsi singkat wajib diisi');

    try {
      bookMessage.textContent = 'Membaca file isi buku...';

      const contentText = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Gagal membaca file .html'));
        reader.readAsText(contentFile);
      });

      bookMessage.textContent = 'Menyimpan buku ke database...';
      const newBookRef = push(ref(db, 'books'));
      await set(newBookRef, {
        title,
        author,
        category,
        price,
        description,
        content: contentText,
        coverURL,
        status,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      bookMessage.style.color = 'var(--success)';
      bookMessage.textContent = 'Selesai! Buku berhasil disimpan.';
      e.target.reset();
      document.getElementById('price-row').style.display = 'none';
      loadBooks();
      loadDashboard();

    } catch (err) {
      showError('Gagal menyimpan: ' + err.message);
      console.error(err);
    }
  });

  function showError(msg) {
    bookMessage.style.color = 'var(--danger)';
    bookMessage.textContent = msg;
  }

  document.getElementById('category').onchange = e => {
    document.getElementById('price-row').style.display = e.target.value === 'premium' ? 'block' : 'none';
  };

  async function loadBooks() {
    bookList.innerHTML = '<p style="color:#999; text-align:center">Memuat daftar buku...</p>';
    try {
      const snap = await get(ref(db, 'books'));
      const books = snap.val() || {};
      bookList.innerHTML = '';

      Object.entries(books).forEach(([id, b]) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div>
            <strong>${b.title}</strong><br>
            <small>${b.author || '—'} • ${b.category} • ${b.status}</small>
          </div>
          <button class="btn-danger" onclick="deleteBook('${id}')">Hapus</button>
        `;
        bookList.appendChild(div);
      });

      if (!Object.keys(books).length) bookList.innerHTML = '<p style="color:#999;text-align:center">Belum ada buku</p>';
    } catch (err) {
      bookList.innerHTML = '<p style="color:var(--danger);text-align:center">Gagal memuat daftar buku</p>';
    }
  }

  window.deleteBook = async id => {
    if (!confirm('Yakin hapus buku ini?')) return;
    await remove(ref(db, `books/${id}`));
    loadBooks();
    loadDashboard();
  };

  async function loadUsers() {
    userList.innerHTML = '<p style="color:#999">Memuat daftar pengguna...</p>';
  }

  loadBooks();
  loadUsers();
</script>

</body>
</html>
